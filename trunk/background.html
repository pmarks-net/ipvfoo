<html>
<head>
<script>

activeRequests = {};

function setIcon(data) {
  addr = data.ip;
  tabId = data.tabId;

  if (addr == undefined) {
    // Incomplete?
    return;
  }

  addr = addr || '?';

  if (addr.indexOf(':') >= 0) {
    icon = "6.png";
  } else if (addr.indexOf('.') >= 0) {
    icon = "4.png";
  } else {
    icon = "question.png";
  }
  chrome.pageAction.setIcon({"tabId": tabId, "path": icon});
  chrome.pageAction.setTitle({"tabId": tabId, "title": addr});
  chrome.pageAction.show(tabId);
}

chrome.experimental.webRequest.onBeforeRequest.addListener(
  function (details) {
    if (details.type != "main_frame") {
      return;
    }
    activeRequests[details.requestId] = {tabId: details.tabId};
  }
);

chrome.experimental.webRequest.onRequestSent.addListener(
  function(details) {
    if (!(details.requestId in activeRequests)) {
      return;
    }
    data = activeRequests[details.requestId];
    data.ip = details.ip;
    setIcon(data);
  }
);

chrome.experimental.webRequest.onCompleted.addListener(
  function(details) {
    if (!(details.requestId in activeRequests)) {
      return;
    }
    data = activeRequests[details.requestId];
    delete activeRequests[details.requestId];
    setIcon(data);
  }
);

chrome.experimental.webRequest.onErrorOccurred.addListener(
  function(details) {
    if (!(details.requestId in activeRequests)) {
      return;
    }
    delete activeRequests[details.requestId];
  }
);

</script>
</head>
</html>
